# 7-1. Spring Data JPA

Spring Data

<br/>

:bulb:  JDBC란 (Java DataBase Connectivity)

자바 언어로 데이터베이스 프로그래밍을 하기위한 라이브러리

```java
String jdbcDriver = "com.mysql.cj.jdbc.Driver"; // MySQL Driver Load
String jdbcUrl = "jdbc:mysql://localhost:3306/user?serverTimezone=Asia/Seoul"; // DataBase 연결

try {
	Class.forName(jdbcDriver).newInstance();
	Connection con = DriverManager.getConnection(jdbcUrl, "root", "root123!@#"); // 계정과 비밀번호 입력
	Statement st = con.createStatement(); // 커넥트
    
	String sql = "SELECT * FROM user"; // 쿼리문
	ResultSet rs = st.executeQuery(sql); // 쿼리문 실행, 결과
    
	while(rs.next()){ // 컬럼에 대한 값 하나씩 꺼내기
	String name = rs.getString(1);
	String age = rs.getString(2);
	String email = rs.getString(3);
        
	System.out.println(name + " " + age + " " + email);
	}
	rs.close();
	st.close();
	con.close();
    
} catch (Exception e) {
	e.printStackTrace();
}
```

:bulb: 날 것의 쿼리를 날려 결과를 얻을 수 있는게 장점이나, 매번 로드를 해야하며 계정정보 또한 날것의 상태로 들어가있으며 예외상황이 많은게 단점

:arrow_right: 위의 단점을 해소하기 위해 나온 것이 JPA

<br/>

JPA란?

Java ORM(Object Relational Mapping) 기술에 대한 인터페이스

:bulb: ORM : 객체와 데이터베이스의 관계를 맵핑하는 방법

```java
// ex) 이 객체와 데이터베이스의 관계를 맵핑
public class User{
	private String name;
	private int age;
	private String email;
}
```

<br/>

Hibernate란?

JPA의 인터페이스를 구현한 라이브러리

:bulb: Hibernate 외에 EclipseLink, DataNucleus, OpenJPA, TopLink 등등 존재

```java
// ex)
public class User{
	private String name;
	private int age;
	private String email;
}

EntityManager entityManager = entityManager.getTransaction().begin();

var user = new User("홍길동", 20, "hong@gmail.com");

entityManager.persist(user);
entityManager.getTransaction().commit(); // DB에 insert
entityManager.close();
```

:bulb: JDBC보다 코드가 간결해졌으나, 여전히 트랜잭션의 begin, 객체생성, persist, commit, close 등 반복동작이 필요하다

<br/>

**Spring Data JPA**

Hibernate 외에 등등 어떠한 라이브러리를 써도 반복되는 작업의 발생,

이를 편리하게 사용하고, Transaction 관리도 Spring에서 관리해주는 형태

```java
@Transactional
public User save(User user) {
	return userRepository.save(user);
}

@Transactional
@Override
public <S extends T> S save(S entity) {
	Assert.notNull(entity, "Entity must not be null.");
	if (entityInformation.isNew(entity)) {
		em.persist(entity); // insert
		return entity;
	} else {
		return em.merge(entity); // or, update
	}
}
```

Hibernate 등에서 하는 반복되는 기능들을 구현해놓고 save만 호출하는 구조

 <br/>

:bulb: DB에 접근하기 위해선 반드시 JDBC를 사용, JDBC에서는 raw한 쿼리가 날아가게 될 것이고, 이것을 구현한것이 Hibernate 또는 다른 라이브러리. 그리고 이 라이브러리들은 JPA라는 인터페이스 규격에 맞춰져 있으며, 한번더 감싸서 추상화 해 만든것이 Spring Data JPA

:arrow_right: JDBC 혹은 Hibernate를 코딩하지 않고, Spring Data JPA가 제공하는 추상클래스를 통해 상속받아 메서드만 호출

<br/>

> Spring initializr
>
> Gradle - Groovy / Java / 2.7.14 / jpa / Jar / 11 / Lombok, Spring Web, Spring Data JPA, MySQL Driver

<br/>

application.properties

main/resources/application.properties

스프링 프로젝트에 대한 여러가지 설정 값들을 지정, yaml 파일 형태로 사용도 가능

```yaml
spring:
  jpa:
    show-sql: true
    properties:
      format_sql: true
      dialect: org.hibernate.dialect.MySQL8Dialect
    hibernate:
      ddl-auto: validate
  datasource:
    url: jdbc:mysql://localhost:3306/user?useSSL=false&useUnicode=true&allowPublicKeyRetrieval=true
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: root
    password: root1234!!
```

<br/>

```java
package com.example.jpa.user.db;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity(name = "user") // 테이블명이 user인 테이블과 맵핑
public class UserEntity {

    @Id // primary key
    @GeneratedValue(strategy = GenerationType.IDENTITY) // id의 생성방식 (MySQL DB에 의해 AutoIncrease가 된다)
    private Long id;
    private String name;
    private Integer age;
    private String email;
}
```

```java
package com.example.jpa.user.db; // SimpleJpaRepository란 클래스를 이미 제공해줬기에 DB 연결 끝

import org.springframework.data.jpa.repository.JpaRepository;

public interface UserRepository extends JpaRepository<UserEntity, Long> {
}
```

```java
package com.example.jpa.user.controller;

@RequiredArgsConstructor
@RestController
@RequestMapping("/api/user")
public class UserApiController {

    private final UserRepository userRepository;

    @GetMapping("/find-all")
    public List<UserEntity> findAll(){
        return userRepository.findAll();
    }
    
    @GetMapping("/name")
    public void autoSave(
        @RequestParam String name
    ){
        var user = UserEntity.builder()
                .name(name)
                .build()
                ;
        userRepository.save(user);
    }
}
```

GET http://localhost:8080/api/user/find-all, 이제는 MySQL DB의 Table 내용을 조회 가능

```json
{
"id": 1,
"name": "이순신",
"age": 1,
"email": ""
},
{
"id": 2,
"name": "유관순",
"age": 1,
"email": ""
},
{
"id": 3,
"name": "강감찬",
"age": 1,
"email": ""
}
```

이미 JPA에서 구현해둔 JpaRepository를 상속받는 것만으로 쿼리를 날리지 않고 findAll() 메서드를 통해 조회 가능

GET http://localhost:8080/api/user/name?name=ABCD, INSERT


:bulb: show-sql : true로 해뒀기에 Hibernate: insert into user (age, email, name) values (?, ?, ?)과 같이 쿼리 표기

<br/>

Spring Data JPA를 사용하면 쿼리문을 사용할 필요가 없다. api를 호출하면 자동으로 hibernate에서 쿼리가 만들어지며 Spring JPA를 통해 실행

<br/>

> Reference
>
> Fastcampuse : Signature Backend